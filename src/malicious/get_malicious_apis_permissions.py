import operator
import os
import pickle

from src.Constant import malicious_path
from src.feature_utils import get_permissions, collect_permissions, get_apis, collect_apis
import androguard

permissions_dict = {}
apis_dict = {}


def main():
    file_names = []
    file_paths = []

    for root, dirs, files in os.walk(malicious_path):
        file_names.append(files)

    for f in file_names[0]:
        path = malicious_path + '/' + str(f)
        file_paths.append(path)

    count = 0
    for path in file_paths:
        print('reading ' + str(count + 1) + ' file', path)
        perms = get_permissions(path)
        collect_permissions(perms, permissions_dict)
        apis = get_apis(path)
        collect_apis(apis, apis_dict)
        count += 1
        # todo test
        # if count > 5:
        #     break

    sorted_permissions_dict = sorted(permissions_dict.items(), key=operator.itemgetter(1), reverse=True)
    print("--sorted_permissions_dict--")
    for key, value in sorted_permissions_dict:
        print(key, value)

    sorted_apis_dict = sorted(apis_dict.items(), key=operator.itemgetter(1), reverse=True)
    print("--sorted_apis_dict--")
    for key, value in sorted_apis_dict:
        print(key, value)

    with open('../../saved_items/malicious_permissions_dict.pickle', 'wb') as handle:
        pickle.dump(sorted_permissions_dict, handle)
    # 将所有的api编译dict
    with open('../../saved_items/malicious_api_calls_dict.pickle', 'wb') as handle:
        pickle.dump(sorted_apis_dict, handle)


if __name__ == '__main__':
    print(androguard.__version__)
    main()

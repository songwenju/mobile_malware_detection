import os
import pickle

import pandas as pd

from src.Constant import malicious_path, malicious_permissions_dict_pick, all_malicious_permissions_csv

# 将 permission 合并到csv中，并标记恶意应用为1
from src.feature_utils import get_permissions


def collect_perms(permissions, permissions_list):
    row = [0 for x in range(len(permissions_list))]
    for perm in permissions:
        index = permissions_list.index(perm)
        # 这里标记了为1，one hot
        row[index] = 1
    return row


def combine_malicious_permissions():
    print("--combine_malicious_permissions--")
    permissions_list = []
    count = 0
    file_names = []
    file_paths = []

    with open(malicious_permissions_dict_pick, 'rb') as handle:
        permissions = pickle.load(handle)

    for permission in permissions:
        # permission：('android.permission.INTERNET', 6)
        # print("permission[0]:", permission)
        permissions_list.append(permission[0])

    # print(permissions_list)

    df = pd.DataFrame(columns=permissions_list)

    for root, dirs, files in os.walk(malicious_path):
        file_names.append(files)

    for f in file_names[0]:
        path = malicious_path + '/' + str(f)
        file_paths.append(path)

    for path in file_paths:
        print('reading ' + str(count + 1) + ' file:', path)
        perms = get_permissions(path)
        row = collect_perms(perms, permissions_list)
        df.loc[count] = row
        count += 1
        # todo test
        # if count > 5:
        #     break

    df.insert(0, "type", 1)
    df.to_csv(all_malicious_permissions_csv)

    # df1 = pd.read_csv('csv/refined_training.csv', index_col=0)
    # df2 = pd.read_csv('csv/all_malicious_permissions.csv', index_col=0)
    #
    # print(len(df1.columns))
    # print(len(df2.columns))
    #
    # df3 = df1.append(df2)
    #
    # df3.fillna(0, inplace=True)
    #
    # print(len(df3.columns))
    # #
    # df3 = df3.loc[:, (df3 != 0).any(axis=0)]
    # print(len(df3.columns))
    # #
    # df3.to_csv('csv/combined_malicious_permissions.csv')
    # #
    # df1 = pd.read_csv('csv/combined_malicious_permissions.csv', index_col=0)
    # print(len(df1.columns))

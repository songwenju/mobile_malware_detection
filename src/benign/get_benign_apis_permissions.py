import operator
import os
import pickle

from src.Constant import benign_path

# 权限字典，key是permission，值是出现的次数
from src.feature_utils import get_permissions, get_apis, collect_permissions_3rgs, collect_apis_3rgs

if __name__ == '__main__':

    permissions_dict = {}
    apis_dict = {}
    global_permissions = []
    global_apis = []
    # 单个apk测试
    # path = "/Users/songwenju/Documents/develop/PycharmProjects/apk_data/malicious_apks/VirusShare_0ab1386c664135e6f8d9cd2ee0315b61.apk"
    # path = "/Users/songwenju/Documents/develop/PycharmProjects/apk_data/benign_apks/192.apk"
    # permissionList = get_permissions(path)
    # collect_permissions(permissionList)
    # apiList = get_apis(path)
    # collect_apis(apiList)
    #
    # print("global apis len:", len(global_apis))
    # print("apiList:", apiList)
    # print("permission dict:", permissions_dict)
    # print("api dict:", apis_dict)

    file_names = []
    file_paths = []

    for root, dirs, files in os.walk(benign_path):
        file_names.append(files)

    for f in file_names[0]:
        path = benign_path + '/' + str(f)
        file_paths.append(path)

    count = 0
    print("total file len:", len(file_names[0]))
    for path in file_paths:
        print('reading ' + str(count + 1) + ' file:', path)
        permission = get_permissions(path)
        collect_permissions_3rgs(global_permissions, permission, permissions_dict)
        apis = get_apis(path)
        collect_apis_3rgs(global_apis, apis, apis_dict)
        count += 1
        # todo test
        if count >= 2:
            break

    sorted_permissions_dict = sorted(permissions_dict.items(), key=operator.itemgetter(1), reverse=True)
    print("--sorted_permissions_dict--")
    for key, value in sorted_permissions_dict:
        print(key, value)

    sorted_apis_dict = sorted(apis_dict.items(), key=operator.itemgetter(1), reverse=True)
    print("--sorted_apis_dict--")
    for key, value in sorted_apis_dict:
        print(key, value)

    with open('../../saved_items/benign_permissions_dict.pickle', 'wb') as handle:
        pickle.dump(sorted_permissions_dict, handle)

    with open('../../saved_items/benign_api_calls_dict.pickle', 'wb') as handle:
        pickle.dump(sorted_apis_dict, handle)

    # global apis 要去重
    with open('../../saved_items/benign_apis_list.pickle', 'wb') as handle:
        pickle.dump(global_apis, handle)
    # global permissions
    with open('../../saved_items/benign_permissions_list.pickle', 'wb') as handle:
        pickle.dump(global_permissions, handle)

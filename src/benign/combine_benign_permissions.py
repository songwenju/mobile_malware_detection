import pickle

import pandas as pd

from src.Constant import benign_permissions_dict_pick, benign_permissions_list_pick, all_benign_permissions_csv


def combine_benign_permissions():
    final_unique_permissions = []

    # 去重后添加排序的permission，这里和malicious不同的是直接操作pickle文件，而不是重新从应用中获取。
    sorted_permissions_benign = []
    # 所有应用对应的permission，二维数组，数组的个数就是应用的个数
    benign_permissions = [[]]

    with open(benign_permissions_dict_pick, 'rb') as handle:
        sorted_permissions_benign = pickle.load(handle)

    with open(benign_permissions_list_pick, 'rb') as handle:
        benign_permissions = pickle.load(handle)

    # sorted_permissions_benign:
    # [('android.permission.ACCESS_COARSE_LOCATION', 2), ('android.permission.ACCESS_FINE_LOCATION', 2)]
    # benign_permissions:
    # [['android.permission.ACCESS_LOCATION', 'ACCESS_NETWORK_STATE'], ['android.permission.ACCESS_WIFI_STATE']]

    print("sorted_permissions_benign:", sorted_permissions_benign)
    print("benign_permissions:", benign_permissions)

    for key in sorted_permissions_benign:
        # permission：('android.permission.INTERNET', 6)
        # print("permission[0]:", permission)
        final_unique_permissions.append(key[0])

    # final_unique_permissions 是最终的 permissions 包含malicious和benign
    # print(final_unique_permissions)

    df = pd.DataFrame(columns=final_unique_permissions)

    print(len(sorted_permissions_benign))
    print(df.shape)

    count = 0
    for apk_perms in benign_permissions:
        row = [0 for _ in final_unique_permissions]
        for perm in apk_perms:
            index = final_unique_permissions.index(perm)
            row[index] = 1
        df.loc[count] = row
        count += 1
        # todo test
        if count > 2:
            break

    print(df.shape)

    df.insert(0, "type", 0)
    df.to_csv(all_benign_permissions_csv)


if __name__ == '__main__':
    combine_benign_permissions()
